{
    "collab_server" : "",
    "contents" : "# main.keywords <- \"iphone6\"\n# filter.words.remove <- c(\"6s\",\"plus\",\"32g\",\"64g\",\"128g\")\n# filter.words.keep <- \"16g\"\n\nscrape_yahoo <- function(main.keywords, filter.words.remove, filter.words.keep){\n  # filter.words.remove : 文字向量\n  # main.keywords, filter.words.keep : 文字\n\n  filter.words.remove <- paste(filter.words.remove, collapse=\"|\")\n  require(plyr)\n  require(rvest)\n  require(magrittr)\n\n  result <- list()\n  page=999\n  i=1\n  options(stringsAsFactors = F)\n\n    url <- sprintf(\"https://tw.search.bid.yahoo.com/search/auction/product;_ylt=Ag3dtVJIWUOh2aOrJrw9RWFyFbN8;_ylv=3?kw=iphone6&p=iphone6&property=auction&sub_property=auction&srch=product&aoffset=0&poffset=0&pg=1&sort=-ptime&nst=1&act=srp&rescheck=1&pptf=3&cid=23960&clv=2\",\n                   main.keywords, main.keywords, (i-1)*60, i)\n    dta <- read_html(url)\n\n    if(page==999){\n      options(warn=-1)\n      pageUrls <- c()\n      tmp <- dta %>% html_nodes(xpath = \"//div[@class='srp_pagination srp_pjax ']\") %>% .[[1]] %>%\n        html_children() %>% .[[1]] %>% html_children()\n      pageUrl <- html_children(tmp) %>% html_attr(\"href\")\n      pages <- dta %>% html_nodes(xpath = \"//div[@class='srp_pagination srp_pjax ']\") %>% .[[1]] %>%\n        html_children() %>% .[[1]] %>% html_children() %>% html_text()\n      page <- pages %>% as.integer() %>% .[!is.na(.)] %>% max()\n\n      while(any(grepl(\"下十頁\",pages))){\n        tmp <- paste0(\"https://tw.search.bid.yahoo.com/search/auction/\", pageUrl[which.max(as.integer(sapply(strsplit(pageUrl, \"&|=\"), function(u){u[grep(\"pg\",u)+1]})))])\n        print(tmp)\n        dta <- read_html(tmp)\n        pages <- dta %>% html_nodes(xpath = \"//div[@class='srp_pagination srp_pjax ']\") %>% .[[1]] %>%\n          html_children() %>% .[[1]] %>% html_children() %>% html_text()\n        page <- pages %>% as.integer() %>% .[!is.na(.)] %>% max()\n\n        # page url\n        tmp <- dta %>% html_nodes(xpath = \"//div[@class='srp_pagination srp_pjax ']\") %>% .[[1]] %>%\n          html_children() %>% .[[1]] %>% html_children()\n        pageUrl <- html_children(tmp) %>% html_attr(\"href\")\n        pages <- dta %>% html_nodes(xpath = \"//div[@class='srp_pagination srp_pjax ']\") %>% .[[1]] %>%\n          html_children() %>% .[[1]] %>% html_children() %>% html_text()\n        page <- pages %>% as.integer() %>% .[!is.na(.)] %>% max()\n        pageUrls <- c(pageUrls, pageUrl)\n      }\n      pageUrls <- unique(pageUrls)\n      options(warn=0)\n    }\n\n    for(i in 1:length(pageUrls)){\n    url <- sprintf(\"https://tw.search.bid.yahoo.com/search/auction/%s\",pageUrls[i])\n    dta <- read_html(url)\n    cat(\"正在擷取第\",i,\"頁，共\",length(pageUrls),\"頁 \\n\")\n    item_list <- (dta %>% html_nodes(xpath = \"//div[@class='list-type yui3-g']\"))[[1]] %>% html_children()\n\n    dta_collection <- lapply(item_list, function(u){\n      result_tmp <- list()\n      tmp <- html_children(u)[[grep(\"wrap\",html_children(u))]] %>% html_children()\n      result_tmp[[1]] <- tmp[[1]] %>% html_children() %>% .[[1]] %>% html_children() %>% html_attr('src') %>% set_names(\"img_link\")\n      result_tmp[[2]] <- tmp[[2]] %>% html_children() %>% .[[1]] %>% html_children() %>% .[1] %>% html_children() %>% html_attr('href') %>% set_names(\"link\")\n      result_tmp[[3]] <- tmp[[2]] %>% html_children() %>% .[[1]] %>% html_children() %>% {\n        name_tmp <- sapply(.,function(u)html_attr(u,'class'))\n        html_text(.) %>% set_names(name_tmp)\n      }\n      result_tmp[[4]] <- tmp[[2]] %>% html_children() %>% .[[2]] %>% html_children() %>% {\n        name_tmp <- sapply(.,function(u)html_attr(u,'class'))\n        html_text(.) %>% set_names(name_tmp)\n      }\n      result_tmp[[5]] <- tmp[[3]] %>% html_children() %>% .[[1]] %>% html_children() %>% {\n        name_tmp <- sapply(.,function(u)html_attr(u,'class'))\n        html_text(.) %>% set_names(name_tmp)\n      }\n      unlist(result_tmp)\n    })\n\n    dta_collection <- lapply(dta_collection,function(u){\n       gsub(\"\\\\n | $\",\"\",u) %>% gsub(\" {2,}\",\" \",.) %>% as.list() %>% as.data.frame()\n    })\n\n    result[[i]] <- do.call(\"rbind.fill\", dta_collection)\n  }\n  result_bind <- ldply(result, rbind)\n  result_bind <- result_bind[!duplicated(result_bind$link),]\n  result_bind$srp.pdtitle %<>% tolower()\n\n  bid.index <- result_bind$srp.pdprice.yui3.g %>% grep(\"次出價\", .)\n  result_bind$bid.times <- 0\n  result_bind$bid.times[bid.index] <- result_bind$srp.pdprice.yui3.g[bid.index] %>% {sapply(strsplit(., \"/\"), \"[[\", 2)} %>%\n    gsub(\" 次出價\",\"\", .) %>% as.integer()\n\n  result_bind <- result_bind[result_bind$bid.times == 0, ]\n\n  result_bind$srp.pdprice.yui3.g <- sapply(strsplit(result_bind$srp.pdprice.yui3.g, \"/\"), \"[[\", 1) %>% gsub(\"\\\\$|,\",\"\",.) %>% as.integer()\n  if(is.null(filter.words.remove)){\n    return(result_bind)\n  }\n  result_bind.filterRemove <- result_bind[-grep(tolower(filter.words.remove),result_bind$srp.pdtitle),]\n  result_bind.filterKeep <- result_bind.filterRemove[grep(filter.words.keep,result_bind.filterRemove$srp.pdtitle),]\n  result_bind.filterKeep\n}\n\nremove_outliers <- function(x, na.rm = TRUE, ...) {\n  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...)\n  H <- 1.5 * IQR(x, na.rm = na.rm)\n  y <- x\n  y <- y[x >= (qnt[1] - H)]\n  y <- y[y <= (qnt[2] + H)]\n  y\n}\n",
    "created" : 1468046188399.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1931171239",
    "id" : "918B4C31",
    "lastKnownWriteTime" : 1468046480,
    "last_content_update" : 1468046480875,
    "path" : "~/YahooScrape/R/yahoo_bid.R",
    "project_path" : "R/yahoo_bid.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}